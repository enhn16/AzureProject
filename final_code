import gradio as gr
from openai import AzureOpenAI
import base64
import re
import os
from google.colab import drive

# =========================
# 0. êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë§ˆìš´íŠ¸
# =========================
if not os.path.exists('/content/drive'):
    drive.mount('/content/drive')

# =========================
# 1. ì„¤ì • ì˜ì—­ (ë¦¬ì†ŒìŠ¤ëŠ” ì´ë¯¸ ì‚­ì œë¨)
# =========================
AZURE_OPENAI_ENDPOINT = "https://smuteam1-oai.openai.azure.com/"
AZURE_OPENAI_API_KEY = "3dhJqdUqFyHpPDlYAyC2e64Wm45d8su3TWoLEB6ySixWe9TlM08dJQQJ99BLACHrzpqXJ3w3AAABACOGm7wb"
AZURE_OPENAI_DEPLOYMENT = "smuteam1-gpt-4o"
EMBEDDING_MODEL_DEPLOYMENT = "smuteam1-text-embedding"

SEARCH_ENDPOINT = "https://smu-team1-search-final.search.windows.net"
SEARCH_KEY = "mW9SG46QbCQFUiNFm7U6isamCyFbCHXAugDf6M1oiXAzSeBacWPJ"
SEARCH_INDEX_NAME = "rag-1766457183781"

RECIPE_LOADING_IMG = "/content/drive/MyDrive/Colab Notebooks/cooking.png"
JUDGE_LOADING_IMG = "/content/drive/MyDrive/Colab Notebooks/check.png"

client = AzureOpenAI(
    api_key=AZURE_OPENAI_API_KEY,
    api_version="2024-05-01-preview",
    azure_endpoint=AZURE_OPENAI_ENDPOINT
)

# =========================
# 2. ì´ë¯¸ì§€ ë³€í™˜ ë° ë¡œë”© HTML
# =========================
def image_to_base64(path):
    if not os.path.exists(path): return None
    try:
        with open(path, "rb") as f:
            encoded_string = base64.b64encode(f.read()).decode("utf-8")
        return f"data:image/png;base64,{encoded_string}"
    except: return None

RECIPE_ICON_B64 = image_to_base64(RECIPE_LOADING_IMG)
JUDGE_ICON_B64 = image_to_base64(JUDGE_LOADING_IMG)

def get_loading_html(message, icon_type="recipe"):
    img_src = RECIPE_ICON_B64 if icon_type == "recipe" else JUDGE_ICON_B64
    if img_src:
        img_tag = f"<img src='{img_src}' style='width: 120px; height: auto; animation: bounce 1s infinite; display: block; margin: 0 auto; border-radius: 10px;'>"
    else:
        img_tag = "<div style='font-size: 50px; animation: bounce 1s infinite;'>ğŸ³</div>"

    return f"""
    <div style='text-align: center; margin-top: 150px;'>
        {img_tag}
        <br>
        <h3 style='color: #555; font-weight: bold; margin-top: 20px;'>{message}</h3>
        <p style='color: #888;'>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
    </div>
    """

# =========================
# 3. í•µì‹¬ ë¡œì§ í•¨ìˆ˜
# =========================

# [ê¸°ëŠ¥ 1] ì‹ ê·œ ë ˆì‹œí”¼ ìƒì„±
def generate_recipe(ingredients, exclude_tools, cook_time, difficulty, extra_request):
    yield get_loading_html("ë² ì§€ê°€ ë ˆì‹œí”¼ë¥¼ êµ¬ìƒ ì¤‘ì´ì—ìš”!", "recipe")

    request_text = extra_request if extra_request else "ì—†ìŒ"

    user_content = f"""
ëƒ‰ì¥ê³  ì¬ë£Œ: {ingredients}
ì œì™¸í•  ì¡°ë¦¬ë„êµ¬: {exclude_tools}
ì¡°ë¦¬ ì‹œê°„ ì¡°ê±´: {cook_time}
ë‚œì´ë„: {difficulty}
ì¶”ê°€ ìš”ì²­ì‚¬í•­: {request_text}

# Task: 1ì¸ë¶„ ë§ì¶¤ ë ˆì‹œí”¼ ìƒì„±
ìœ„ ì¡°ê±´ì— ë§ëŠ” ë ˆì‹œí”¼ë¥¼ ë§Œë“¤ì–´ì¤˜. ì¸ì‚¬ë§ ì—†ì´ ë°”ë¡œ '# ğŸ½ï¸ ìš”ë¦¬ëª…'ë¶€í„° ì‹œì‘í•´.
- **ë¶„ëŸ‰ ì—„ìˆ˜:** ë°˜ë“œì‹œ '1ì¸ë¶„' ê¸°ì¤€.
- **ë„êµ¬ ì œí•œ:** ì‚¬ìš©ìê°€ ëª» ì“´ë‹¤ê³  ëª…ì‹œí•œ ë„êµ¬ ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€.
- **ì¬ë£Œ ì œí•œ:** ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì¬ë£Œë§Œ ì‚¬ìš©. **(ë°¥, ë©´, ë¹µ, ë°€ê°€ë£¨ ìë™ ì¶”ê°€ ê¸ˆì§€)**
- **ê¸°ë³¸ ì–‘ë…:** ê°„ì¥, ì„¤íƒ•, ì†Œê¸ˆ, ê³ ì¶”ì¥ ë“± ê¸°ë³¸ ì–‘ë…ë§Œ í—ˆìš©.
- **í˜•ì‹:** ìš”ë¦¬ ì´ë¦„ ë°‘ì˜ ì„¤ëª…ì€ **ì ˆëŒ€ í—¤ë”(#)ë‚˜ ë³¼ë“œ(**) ì—†ì´ í‰ë¬¸**ìœ¼ë¡œ ì‘ì„±.

[ë ˆì‹œí”¼ ì¶œë ¥ ì–‘ì‹]
## ğŸ½ï¸ (ìš”ë¦¬ ì´ë¦„)
(ìš”ë¦¬ íŠ¹ì§• í‰ë¬¸ ì„¤ëª…)
---
### ğŸ›’ ì¤€ë¹„ë¬¼
- (ì¬ë£Œ ë¦¬ìŠ¤íŠ¸)
---
### ğŸ‘¨â€ğŸ³ ì¡°ë¦¬ ë‹¨ê³„
1. (ë‹¨ê³„ë³„ ì„¤ëª…)
2. ...
---
### ğŸ’¡ ì…°í”„ì˜ ê¿€íŒ
- (íŒ ë‚´ìš©)
"""
    try:
        response = client.chat.completions.create(
            model=AZURE_OPENAI_DEPLOYMENT,
            messages=[
                {"role": "system", "content": "ë„ˆëŠ” ìì·¨ ì „ë¬¸ ì…°í”„ë‹¤. ë°¥/ë©´/ë¹µì„ ë©‹ëŒ€ë¡œ ì¶”ê°€í•˜ì§€ ë§ê³ , ì¶œë ¥ í˜•ì‹ì„ ì—„ìˆ˜í•˜ë¼."},
                {"role": "user", "content": user_content}
            ],
            extra_body={
                "data_sources": [
                    {
                        "type": "azure_search",
                        "parameters": {
                            "endpoint": SEARCH_ENDPOINT,
                            "index_name": SEARCH_INDEX_NAME,
                            "authentication": {"type": "api_key", "key": SEARCH_KEY},
                            "query_type": "vector",
                            "embedding_dependency": {"type": "deployment_name", "deployment_name": EMBEDDING_MODEL_DEPLOYMENT}
                        }
                    }
                ]
            },
            temperature=0.7
        )
        yield response.choices[0].message.content

    except Exception as e:
        yield f"âŒ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"

# [ê¸°ëŠ¥ 2] ê¸°ì¡´ ë ˆì‹œí”¼ ìˆ˜ì • (Refine)
def refine_recipe(current_recipe, ingredients, exclude_tools, cook_time, difficulty, extra_request):
    # ë§Œì•½ ê¸°ì¡´ ë ˆì‹œí”¼ê°€ ë¹„ì–´ìˆë‹¤ë©´(ì•„ì§ ìƒì„± ì•ˆí•¨), ê·¸ëƒ¥ ìƒˆë¡œ ìƒì„± í•¨ìˆ˜ë¡œ ë„˜ê¹€
    if not current_recipe:
        yield from generate_recipe(ingredients, exclude_tools, cook_time, difficulty, extra_request)
        return

    yield get_loading_html("ë² ì§€ê°€ ìš”ì²­ì‚¬í•­ì„ ë°˜ì˜í•´ ìˆ˜ì • ì¤‘ì´ì—ìš”!", "recipe")

    user_content = f"""
# Task: ê¸°ì¡´ ë ˆì‹œí”¼ ìˆ˜ì • (Refinement)
ë„ˆëŠ” ì§€ê¸ˆ ì‚¬ìš©ìê°€ ë³´ê³  ìˆëŠ” ë ˆì‹œí”¼ë¥¼ **ìˆ˜ì •**í•´ì•¼ í•œë‹¤. ì™„ì „íˆ ìƒˆë¡œ ë§Œë“¤ì§€ ë§ê³ , ê¸°ì¡´ ë ˆì‹œí”¼ì˜ íë¦„ì„ ìœ ì§€í•˜ë˜ **ì¶”ê°€ ìš”ì²­ì‚¬í•­**ì„ ë°˜ì˜í•´ë¼.

[ê¸°ì¡´ ë ˆì‹œí”¼ ë‚´ìš©]
{current_recipe}

[ì‚¬ìš©ìì˜ ìˆ˜ì • ìš”ì²­]
"{extra_request}"

[ì œì•½ ì‚¬í•­ (ìœ ì§€)]
1. ì¬ë£Œ: {ingredients} (ë°¥, ë©´, ë¹µ ë©‹ëŒ€ë¡œ ì¶”ê°€ ê¸ˆì§€)
2. ë„êµ¬: {exclude_tools} ì‚¬ìš© ê¸ˆì§€
3. ì¶œë ¥ í˜•ì‹: ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ (ì„¤ëª… ì¤„ì— í—¤ë”/ë³¼ë“œ ê¸ˆì§€)

ìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ìˆ˜ì •ëœ ì™„ë²½í•œ ë ˆì‹œí”¼ë¥¼ ë‹¤ì‹œ ì¶œë ¥í•´ì¤˜.
"""
    try:
        response = client.chat.completions.create(
            model=AZURE_OPENAI_DEPLOYMENT,
            messages=[
                {"role": "system", "content": "ë„ˆëŠ” ìì·¨ ì „ë¬¸ ì…°í”„ë‹¤. ê¸°ì¡´ ë ˆì‹œí”¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì˜ ìˆ˜ì • ìš”ì²­ì„ ë°˜ì˜í•˜ë¼."},
                {"role": "user", "content": user_content}
            ],
            temperature=0.7
        )
        yield response.choices[0].message.content
    except Exception as e:
        yield f"âŒ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"

# [ê¸°ëŠ¥ 3] ì´ë¯¸ì§€ ë¶„ì„ (ê¸°ì¡´ ìœ ì§€)
def encode_uploaded_image(image_path):
    with open(image_path, "rb") as f:
        return base64.b64encode(f.read()).decode("utf-8")

def judge_food(image_path):
    base64_image = encode_uploaded_image(image_path)
    user_instruction = """
# Task: ì‹ì¬ë£Œ ìƒíƒœ ì§„ë‹¨
[ì¶œë ¥ ì–‘ì‹]
ğŸ¥¬ **ì‹ì¬ë£Œ ìƒíƒœ ì§„ë‹¨**
- **ì¬ë£Œëª…:** (ì¬ë£Œ ì´ë¦„)
- **ì‹ ì„ ë„ ë“±ê¸‰:** (ì–‘í˜¸/ë³´í†µ/íê¸°)
- **ì™¸ê´€ìƒì˜ íŠ¹ì§•:** (ìƒì„¸ ì„¤ëª…)
- **ì¡°ë¦¬ ì‹œ ì£¼ì˜ì :** (ì†ì§ˆ ë°©ë²• ë° ë³´ê´€ íŒ)
"""
    response = client.chat.completions.create(
        model=AZURE_OPENAI_DEPLOYMENT,
        messages=[
            {"role": "system", "content": "ë„ˆëŠ” ì‹ì¬ë£Œ ìƒíƒœ ì§„ë‹¨ ì „ë¬¸ê°€ì´ë‹¤."},
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": user_instruction},
                    {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}}
                ]
            }
        ],
        temperature=0.1
    )
    return response.choices[0].message.content

def judge_and_toggle(image):
    if image is None:
        yield "âš ï¸ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.", gr.update(visible=False), ""
        return

    yield get_loading_html("ë² ì§€ê°€ ê¼¼ê¼¼íˆ í™•ì¸í•˜ê³  ìˆì–´ìš”!", "judge"), gr.update(visible=False), ""

    try:
        result = judge_food(image)
        is_bad = "íê¸°" in result
        show_button = not is_bad
        name_match = re.search(r"ì¬ë£Œëª…:\s*\**([^\n\*]+)", result)
        ingredient = name_match.group(1).strip() if name_match else ""
        yield result, gr.update(visible=show_button), ingredient
    except Exception as e:
        yield f"âŒ ì˜¤ë¥˜ ë°œìƒ: {str(e)}", gr.update(visible=False), ""

def clear_image(): return None, gr.update(visible=False), ""
def go_home(): return gr.update(visible=True), gr.update(visible=False), gr.update(visible=False)
def go_page1(initial_ingred=""):
    return gr.update(visible=False), gr.update(visible=True), gr.update(visible=False), initial_ingred, [], "ìƒê´€ì—†ìŒ", "ìƒê´€ì—†ìŒ", "", ""
def go_page2(): return gr.update(visible=False), gr.update(visible=False), gr.update(visible=True)

# =========================
# 4. Gradio UI êµ¬ì„±
# =========================
css = """
body { background-color: #f5f5f5; }
.fixed-output-box { height: 600px !important; overflow-y: auto !important; background-color: #ffffff !important; border: 2px solid #ddd; border-radius: 8px; padding: 20px; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }
.fixed-output-box .prose, .fixed-output-box div, .fixed-output-box span, .fixed-output-box p, .fixed-output-box h3 { background-color: transparent !important; }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
.home-icon-btn { font-size: 24px !important; min-width: 40px !important; background: none !important; border: 1px solid #ccc !important; border-radius: 8px !important; margin-top: 10px !important; }
.home-main-btn { height: 180px; font-size: 22px; border-radius: 15px; }
.page-header-title { text-align: center; font-size: 26px; font-weight: bold; color: #333; padding: 15px 0; border-top: 3px solid #ddd; border-bottom: 3px solid #ddd; margin-bottom: 20px; width: 100%; }
"""

with gr.Blocks(css=css, theme=gr.themes.Soft()) as demo:
    auto_ingredient = gr.State("")

    with gr.Column(visible=True) as home:
        gr.Markdown("# ëƒ‰ì¥ê³  êµ¬ì¡°ëŒ€ ğŸš‘", elem_id="main-title")
        gr.Markdown("---")
        with gr.Row():
            btn1 = gr.Button("ğŸ“ 1ì¸ë¶„ ëšë”± ë ˆì‹œí”¼", elem_classes="home-main-btn")
            btn2 = gr.Button("ğŸ“¸ ì‹ì¬ë£Œ ì•ˆì‹¬ ìŠ¤ìºë„ˆ", elem_classes="home-main-btn")

    with gr.Column(visible=False) as page1:
        with gr.Row(equal_height=True):
            home_btn1 = gr.Button("ğŸ ", elem_classes="home-icon-btn", scale=0)
            with gr.Column(scale=9): gr.HTML("<div class='page-header-title'>ğŸ“ 1ì¸ë¶„ ëšë”± ë ˆì‹œí”¼</div>")
        with gr.Row():
            with gr.Column(scale=1):
                gr.Markdown("### 1ë‹¨ê³„ | ëƒ‰ì¥ê³  ì† ì¬ë£Œ ì…ë ¥")
                ingredients = gr.Textbox(placeholder="ì˜ˆ: ê³„ë€, ìŠ¤íŒ¸, ê¹€ì¹˜", show_label=False)
                gr.Markdown("### 2ë‹¨ê³„ | ì œì™¸í•  ìš”ë¦¬ë„êµ¬ ì„ íƒ")
                exclude_tools = gr.CheckboxGroup(["ì—ì–´í”„ë¼ì´ì–´", "ì˜¤ë¸", "ì „ìë ˆì¸ì§€"], show_label=False)
                gr.Markdown("### 3ë‹¨ê³„ | ìš”ë¦¬ ì‹œê°„ê³¼ ë‚œì´ë„ ì„ íƒ")
                with gr.Row():
                    cook_time = gr.Dropdown(["ìƒê´€ì—†ìŒ", "15ë¶„ ì´ë‚´", "30ë¶„ ì´ë‚´"], label="ìš”ë¦¬ ì‹œê°„", value="ìƒê´€ì—†ìŒ")
                    difficulty = gr.Dropdown(["ìƒê´€ì—†ìŒ", "ì‰¬ì›€", "ë³´í†µ", "ì–´ë ¤ì›€"], label="ë‚œì´ë„", value="ìƒê´€ì—†ìŒ")
                gr.Markdown("<br>")
                submit_btn = gr.Button("ğŸ‘¨â€ğŸ³ ë ˆì‹œí”¼ ìƒì„±í•˜ê¸°", variant="primary")
            with gr.Column(scale=1):
                with gr.Group(elem_classes="fixed-output-box"): output_box = gr.Markdown(value="")
                gr.Markdown("### â• ì¶”ê°€ ìš”êµ¬ì‚¬í•­ (ê²°ê³¼ ìˆ˜ì •ìš©)")
                extra_request = gr.Textbox(placeholder="ì˜ˆ: êµ­ë¬¼ ìš”ë¦¬ë¡œ ë°”ê¿”ì¤˜, ë” ë§µê²Œ í•´ì¤˜", show_label=False)
                refine_btn = gr.Button("ğŸ”„ ì¶”ê°€ ìš”êµ¬ì‚¬í•­ ë°˜ì˜í•˜ì—¬ ë‹¤ì‹œ ìƒì„±")

    with gr.Column(visible=False) as page2:
        with gr.Row(equal_height=True):
            home_btn2 = gr.Button("ğŸ ", elem_classes="home-icon-btn", scale=0)
            with gr.Column(scale=9): gr.HTML("<div class='page-header-title'>ğŸ“¸ ì‹ì¬ë£Œ ì•ˆì‹¬ ìŠ¤ìºë„ˆ</div>")
        with gr.Row():
            with gr.Column(scale=1):
                image = gr.Image(type="filepath", label="ì¬ë£Œ ì‚¬ì§„", height=400)
                with gr.Row():
                    judge_btn = gr.Button("ğŸ” ìƒíƒœ ì§„ë‹¨ ì‹œì‘", variant="primary")
                    clear_btn = gr.Button("ğŸ”„ ì‚¬ì§„ ì¬ì—…ë¡œë“œ")
            with gr.Column(scale=1):
                with gr.Group(elem_classes="fixed-output-box"): judge_result = gr.Markdown(value="")
                to_recipe = gr.Button("ğŸ³ ì´ ì¬ë£Œë¡œ ë°”ë¡œ ìš”ë¦¬í•˜ê¸°", visible=False, variant="primary")

    # [ì—°ê²°] ë©”ì¸ ë ˆì‹œí”¼ ìƒì„± ë²„íŠ¼
    submit_btn.click(generate_recipe, inputs=[ingredients, exclude_tools, cook_time, difficulty, extra_request], outputs=output_box)

    # [ì—°ê²° ìˆ˜ì •] ì¶”ê°€ ìš”ì²­ì‚¬í•­ ë°˜ì˜ ë²„íŠ¼ (output_boxë¥¼ ì…ë ¥ìœ¼ë¡œ ë°›ìŒ!)
    refine_btn.click(refine_recipe, inputs=[output_box, ingredients, exclude_tools, cook_time, difficulty, extra_request], outputs=output_box)

    btn1.click(go_page1, outputs=[home, page1, page2, ingredients, exclude_tools, cook_time, difficulty, extra_request, output_box])
    btn2.click(go_page2, outputs=[home, page1, page2])
    home_btn1.click(go_home, outputs=[home, page1, page2])
    home_btn2.click(go_home, outputs=[home, page1, page2])
    judge_btn.click(judge_and_toggle, inputs=image, outputs=[judge_result, to_recipe, auto_ingredient])
    clear_btn.click(clear_image, outputs=[image, to_recipe, judge_result])
    to_recipe.click(go_page1, inputs=auto_ingredient, outputs=[home, page1, page2, ingredients, exclude_tools, cook_time, difficulty, extra_request, output_box])

demo.launch()
